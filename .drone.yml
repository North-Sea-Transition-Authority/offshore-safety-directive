kind: pipeline
type: docker
name: default

steps:

  - name: restore-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: drone-cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./node_modules
        # We can only mount volume caches into the working directory, so all steps which use Gradle must have
        # the GRADLE_USER_HOME environment variable pointing here.
        - ./gradle_cache
        - ./sonar_cache

  - name: build-backend
    image: eclipse-temurin:17-jdk
    environment:
      SONAR_TOKEN:
        from_secret: sonarcloud_token
    commands:
      - chmod +x gradlew
      - ./gradlew test bootJar sonarqube

  - name: sync-reports
    image: alpine:3.16.0
    commands:
      - mkdir -p /var/webfiles/${DRONE_BUILD_NUMBER}
      - cp -r build/reports /var/webfiles/${DRONE_BUILD_NUMBER}
    volumes:
      - name: webfiles
        path: /var/webfiles
    when:
      status: [ success, failure ]

  - name: publish-docker-develop
    image: plugins/docker:19.03.8
    settings:
      registry: quay.io
      repo: quay.io/fivium/offshore-safety-directive
      tags:
        - develop
      config:
        from_secret: docker_config
    when:
      branch:
        - develop
      status:
        - success

  - name: publish-docker
    image: plugins/docker:19.03.8
    settings:
      registry: quay.io
      repo: quay.io/fivium/offshore-safety-directive
      tags:
        - ${DRONE_BRANCH/\//-}-${DRONE_BUILD_NUMBER}
      config:
        from_secret: docker_config
    when:
      branch:
        - main
        - hotfix/**
        - release/**
      status:
        - success

  - name: trivy-build-image
    image: docker:20.10.9
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
    commands:
      - docker build -t quay.io/fivium/offshore-safety-directive:trivy-scan-target .

  - name: trivy-scan
    image: aquasec/trivy:0.20.0
    volumes:
      - name: docker-sock
        path: /var/run/docker.sock
      - name: drone-trivy-cache
        path: /root/trivy-cache
      - name: webfiles
        path: /var/webfiles
    commands:
      # timeout set as initial cache population can seemingly take a while sometimes
      - trivy --format template --template "@contrib/html.tpl" -o /var/webfiles/${DRONE_BUILD_NUMBER}/trivy-scan.html image --timeout 30m --exit-code 1 quay.io/fivium/offshore-safety-directive:trivy-scan-target
      - echo trivy scan reports published at http://drone-assets.fivium.local:9090/offshore-safety-directive/${DRONE_BUILD_NUMBER}/
    when:
      status:
        - success

  - name: rebuild-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: drone-cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./node_modules
        - ./gradle_cache
        - ./sonar_cache

  - name: slack
    image: plugins/slack
    settings:
      webhook: https://hooks.slack.com/services/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
      channel: offshore-safety-directive-builds
      template: "*{{build.status}}* <{{build.link}}|Commit {{truncate build.commit 7}} on {{build.branch}} by ${DRONE_COMMIT_AUTHOR_NAME}>\nReports published to: http://drone-assets.fivium.local:9090/offshore-safety-directive/{{build.number}}/"
    when:
      status: [ success, failure ]

volumes:
  - name: webfiles
    host:
      path: /home/fivium/www/offshore-safety-directive

  - name: drone-cache
    host:
      path: /home/fivium/drone-cache

  - name: docker-sock
    host:
      path: /var/run/docker.sock

  - name: drone-trivy-cache
    host:
      path: /root/.cache/

---

kind: secret
name: docker_config
data: GHVOXxAK7e/DsSw9I8LdzoCJVMFOWtFHcd+9vMEjq+MH6tK//qSZhh+kTM8BpniFU4qujR2KA0lYrxoQb+Hv7KVOLB2eU5VtZYYksnaHwRsf5lY0UD6azSvRqStqmHn2ET+7i5YAuyYNj1IhzAkiXZyz9NknVqRHC4SuI6qiGnxtU5DdSjNps1dqVr7V6WN/FOYwvMAnIuii4kxhMp9ti2/rVbAbjmZf7CpW9zyP58da55sHqusZWjB/mlf3gz+Nhndm7j24mQOcyIV1GgOltv121Qt7y22VMVWZCrwRE3Xy20YLSCh1x7wkvT0nKSDtgjQ+uaDKtE/mJmGF+5Vj2/83GNFmEzzE6vv52xBF

---

kind: secret
name: sonarcloud_token
data: qGI/3GMzl5uIWHaCGjbPQYcW0pABTPglsFKDyZTPssuHSYIgyoPAWr34a9wu720PTUaFv4sBLxCMvs2R8O0XeJ49GbM=
